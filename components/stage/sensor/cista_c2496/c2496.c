#include <bl808.h>
#include "sensor_internal.h"
#include "sccb.h"
#include "c2496.h"

/* C2496 sensor info */
#define SLAVE_ADDR                  0x36
#define SENSOR_ID_H                 0x02
#define SENSOR_ID_L                 0x08
#define MIN_EXPO_TIME               32848                       /* 32848 ns or -49.5 dB */
#define MAX_EXPO_TIME               EXPO_TIME_1_25_SEC          /* 1/25 sec */
#define REG_ADDR_BIT                SENSOR_REG_ADDR_16BIT

//#define MAX_GAIN                    GAIN_DB_FLOAT_TO_INT(53.25)    /* 53.25 dB */
#define MAX_GAIN                    GAIN_DB_FLOAT_TO_INT(36)    /* limit max gain t0 36 dB to avoid bad noise */
#define MAX_AGAIN                   GAIN_DB_FLOAT_TO_INT(23.625)   /* 23.625 dB or 15.5x */
#define MIN_GAIN_STEP               (GAIN_6_DB / 16)            /* 0.375 dB */

/* C2496 registers */
#define REG_SENSOR_ID_H             0x0000
#define REG_SENSOR_ID_L             0x0001
#define REG_GROUP_HOLD              0x3812
#define REG_PRECHARGE               0x3314
#define REG_DIGITAL_GAIN            0x3e06
#define REG_DIGITAL_FINE_GAIN       0x3e07
#define REG_COARSE_GAIN             0x3e08
#define REG_FINE_GAIN               0x3e09
#define REG_SHUTTER_TIME_H          0x0202
#define REG_SHUTTER_TIME_L          0x0303

#define REG_TOTAL_WIDTH_H           0x3f06
#define REG_TOTAL_WIDTH_L           0x3f07
#define REG_TOTAL_HEIGHT_H          0x3f04
#define REG_TOTAL_HEIGHT_L          0x3f05

#define REG_OUT_WIDTH_H             0x3f06
#define REG_OUT_WIDTH_L             0x3f07
#define REG_OUT_HEIHT_H             0x3f04
#define REG_OUT_HEIHT_L             0x3f05

#define REG_OUT_START_PIXEL_H       0x3f00
#define REG_OUT_START_PIXEL_L       0x3f01
#define REG_OUT_START_LINE_H        0x3f02
#define REG_OUT_START_LINE_L        0x3f03

typedef enum {
    FORMAT_INDEX_1080P_30 = 0,
    FORMAT_INDEX_1080P_25,
    FORMAT_INDEX_1080P_20,
    FORMAT_INDEX_1080P_20_2,
    FORMAT_INDEX_1080P_15,
    FORMAT_INDEX_1080P_12P5,
    FORMAT_INDEX_1080P_10,
    FORMAT_INDEX_1080P_5,
    FORMAT_INDEX_INVALID,
} FORMAT_INDEX;


static const sensor_format_t format_info[] = {
    {   /* for 1080p30 */
        .total_width    = 2412,
        .total_height   = 1104,
        .pix_clk        = 80000000,
        .fps            = 30,
    },
};

static const sensor_reg_16_8_t init_reglist_30fps[] =
{

    {0x0103,0x01},

    //analog
    {0x3280, 0x6a},
    {0x32aa, 0x05}, //adc range 750mV
    {0x32ab, 0x08},
    {0x32ac, 0xdf},
    {0x32af, 0x00},
    {0x3286, 0x60},
    {0x3287, 0x4c}, //
    {0x3290, 0xe5},
    {0x3211, 0x14},
    {0x3212, 0x80},
    {0x3213, 0x03},
    {0x3215, 0x30},
    {0x3216, 0x40},
    {0x3217, 0x30},
    {0x3218, 0x50},
    {0x3223, 0x20},

    {0x3288,0x50}, //tm
    {0x0401,0x3b},
    {0x0403,0x00},

    //digital
    {0x3584,0x02},
    {0x3182,0x30},
    {0x3183,0x00}, //orc_en off
    {0x3180,0x20},
    {0x3187,0x14},
    {0x3026,0x01},
    //0x3009,0x05
    {0x3c01,0x17},
    {0x3c14,0x20},
    {0x3108,0xcf},
    {0x3112,0xf0},
    {0x3126,0x03},
    {0x3584,0x22},
    {0x32c8,0x22}, //dmirror
    {0x32ca,0x22}, //channel merge
    {0x3d14,0x22},
    {0x3885,0x22}, //mfifo
    {0x3640,0x22},
    //
    {0x0202,0x02},
    {0x3f10,0x00},
    {0x0101,0x00},

    //0x0342,0x08
    //0x0343,0xde
    //hvbin
    //0x0340,0x02
    //0x0341,0x28
    //0x034c,0x03
    //0x034d,0xc0
    //0x034e,0x02
    //0x034f,0x1c
    //0x3000,0x80
    //0x3001,0x05
    //0x3021,0x22
    //0x0387,0x03
    //0x3210,0x1a
    //0x3514,0x04

    //pll
    {0x0307,0x64}, //pll1=800M
    //0x0304,0x05 //05: 15fps, 0a: 7.5fps

    //mipi
    //0x3805,0x07
    //0x3806,0x04 //02: halfspeed
    //0x3807,0x04 //02: halfspeed
    //0x3808,0x16
    //0x3809,0x85
    //0x380a,0x6d
    //0x380b,0xaa

    //dvp
    {0x3905,0x00},
    {0x3584,0x2a}, //bin2: 3a
    {0x3986,0x01},
    {0x3810,0x00},
    {0x3295,0x55},
    {0x3981,0x23},
    {0x3987,0x02},
    {0x3988,0xfb},  //ff
    {0x3882,0x01},

    {0x3600,0xc8},
    {0x3602,0x01},
    {0x3583,0x10},
    {0x3584,0x02},
    {0xa000,0x0b},
    {0xa001,0x50},
    {0xa002,0x00},
    {0xa003,0x00},
    {0xa004,0x00},
    {0xa005,0x80},
    {0xa006,0x80},
    {0xa007,0x00},
    {0xa008,0xce},
    {0xa009,0x81},
    {0xa00a,0x83},
    {0xa00b,0x9c},
    {0xa00c,0x03},
    {0xa00d,0xa5},
    {0xa00e,0x8d},
    {0xa00f,0x01},
    {0xa010,0x0a},
    {0xa011,0x10},
    {0xa012,0x0e},
    {0xa013,0x01},
    {0xa014,0x8c},
    {0xa015,0xd0},
    {0xa016,0x2f},
    {0xa017,0xd1},
    {0xa018,0x85},
    {0xa019,0xe0},
    {0xa01a,0x05},
    {0xa01b,0x01},
    {0xa01c,0x02},
    {0xa01d,0x60},
    {0xa01e,0x06},
    {0xa01f,0x81},
    {0xa020,0x88},
    {0xa021,0x10},
    {0xa022,0x9d},
    {0xa023,0x81},
    {0xa024,0x08},
    {0xa025,0x90},
    {0xa026,0x9d},
    {0xa027,0x01},
    {0xa028,0x1d},
    {0xa029,0x10},
    {0xa02a,0x90},
    {0xa02b,0x7c},
    {0xa02c,0x1e},
    {0xa02d,0x81},
    {0xa02e,0x00},
    {0xa02f,0x61},
    {0xa030,0x1e},
    {0xa031,0x04},
    {0xa032,0x03},
    {0xa033,0x30},
    {0xa034,0xb5},
    {0xa035,0x50},
    {0xa036,0xc0},
    {0xa037,0x60},
    {0xa038,0x9e},
    {0xa039,0x04},
    {0xa03a,0x83},
    {0xa03b,0x30},
    {0xa03c,0xad},
    {0xa03d,0x50},
    {0xa03e,0x20},
    {0xa03f,0x60},
    {0xa040,0x1e},
    {0xa041,0x84},
    {0xa042,0x03},
    {0xa043,0xb0},
    {0xa044,0x25},
    {0xa045,0x50},
    {0xa046,0x87},
    {0xa047,0xe0},
    {0xa048,0x26},
    {0xa049,0x50},
    {0xa04a,0x03},
    {0xa04b,0xe0},
    {0xa04c,0x93},
    {0xa04d,0x01},
    {0xa04e,0x94},
    {0xa04f,0x83},
    {0xa050,0x94},
    {0xa051,0x10},
    {0xa052,0x12},
    {0xa053,0x01},
    {0xa054,0x93},
    {0xa055,0x90},
    {0xa056,0x91},
    {0xa057,0x01},
    {0xa058,0x30},
    {0xa059,0x50},
    {0xa05a,0x91},
    {0xa05b,0x03},
    {0xa05c,0x11},
    {0xa05d,0x15},
    {0xa05e,0x12},
    {0xa05f,0x03},
    {0xa060,0x12},
    {0xa061,0x90},
    {0xa062,0x90},
    {0xa063,0x01},
    {0xa064,0x91},
    {0xa065,0x10},
    {0xa066,0x8f},
    {0xa067,0x01},
    {0xa068,0x37},
    {0xa069,0xd0},
    {0xa06a,0x8f},
    {0xa06b,0x03},
    {0xa06c,0x90},
    {0xa06d,0x83},
    {0xa06e,0x0f},
    {0xa06f,0x10},
    {0xa070,0x9b},
    {0xa071,0x01},
    {0xa072,0x80},
    {0xa073,0xe1},
    {0xa074,0x9e},
    {0xa075,0x04},
    {0xa076,0x83},
    {0xa077,0x30},
    {0xa078,0x59},
    {0xa079,0xd0},
    {0xa07a,0x40},
    {0xa07b,0x60},
    {0xa07c,0x1e},
    {0xa07d,0x04},
    {0xa07e,0x03},
    {0xa07f,0x30},
    {0xa080,0x50},
    {0xa081,0xd0},
    {0xa082,0xa0},
    {0xa083,0xe0},
    {0xa084,0x1e},
    {0xa085,0x84},
    {0xa086,0x83},
    {0xa087,0xb0},
    {0xa088,0x47},
    {0xa089,0x50},
    {0xa08a,0x9e},
    {0xa08b,0x10},
    {0xa08c,0xc9},
    {0xa08d,0xd0},
    {0xa08e,0x83},
    {0xa08f,0xa0},
    {0xa090,0x1e},
    {0xa091,0x18},
    {0xa092,0x19},
    {0xa093,0x01},
    {0xa094,0x9a},
    {0xa095,0x03},
    {0xa096,0x9a},
    {0xa097,0x90},
    {0xa098,0x18},
    {0xa099,0x81},
    {0xa09a,0x99},
    {0xa09b,0x90},
    {0xa09c,0x97},
    {0xa09d,0x81},
    {0xa09e,0x54},
    {0xa09f,0xd0},
    {0xa0a0,0x23},
    {0xa0a1,0x41},
    {0xa0a2,0x8c},
    {0xa0a3,0x10},
    {0xa0a4,0x17},
    {0xa0a5,0x81},
    {0xa0a6,0x98},
    {0xa0a7,0x03},
    {0xa0a8,0x98},
    {0xa0a9,0x90},
    {0xa0aa,0x96},
    {0xa0ab,0x01},
    {0xa0ac,0x97},
    {0xa0ad,0x10},
    {0xa0ae,0x95},
    {0xa0af,0x81},
    {0xa0b0,0x5f},
    {0xa0b1,0xd0},
    {0xa0b2,0xa3},
    {0xa0b3,0x41},
    {0xa0b4,0x03},
    {0xa0b5,0x20},
    {0xa0b6,0x8c},
    {0xa0b7,0x19},
    {0xa0b8,0x0c},
    {0xa0b9,0x10},
    {0xa0ba,0x95},
    {0xa0bb,0x01},
    {0xa0bc,0x96},
    {0xa0bd,0x83},
    {0xa0be,0x95},
    {0xa0bf,0x10},
    {0xa0c0,0x9c},
    {0xa0c1,0x01},
    {0xa0c2,0x93},
    {0xa0c3,0x61},
    {0xa0c4,0x05},
    {0xa0c5,0x01},
    {0xa0c6,0xb2},
    {0xa0c7,0x60},
    {0xa0c8,0x86},
    {0xa0c9,0x81},
    {0xa0ca,0x1b},
    {0xa0cb,0x10},
    {0xa0cc,0x08},
    {0xa0cd,0x81},
    {0xa0ce,0x29},
    {0xa0cf,0xe1},
    {0xa0d0,0x85},
    {0xa0d1,0x81},
    {0xa0d2,0xb2},
    {0xa0d3,0x60},
    {0xa0d4,0x86},
    {0xa0d5,0x81},
    {0xa0d6,0x9c},
    {0xa0d7,0x90},
    {0xa0d8,0x88},
    {0xa0d9,0x01},
    {0xa0da,0x40},
    {0xa0db,0xe0},
    {0xa0dc,0x1e},
    {0xa0dd,0x04},
    {0xa0de,0x0a},
    {0xa0df,0xe0},
    {0xa0e0,0x03},
    {0xa0e1,0x38},
    {0xa0e2,0x7e},
    {0xa0e3,0xd0},
    {0xa0e4,0x85},
    {0xa0e5,0x01},
    {0xa0e6,0x31},
    {0xa0e7,0x60},
    {0xa0e8,0x06},
    {0xa0e9,0x01},
    {0xa0ea,0x10},
    {0xa0eb,0xe1},
    {0xa0ec,0x88},
    {0xa0ed,0x01},
    {0xa0ee,0x8b},
    {0xa0ef,0xe0},
    {0xa0f0,0x9d},
    {0xa0f1,0xc1},
    {0xa0f2,0x0c},
    {0xa0f3,0x60},
    {0xa0f4,0x1d},
    {0xa0f5,0xc1},
    {0xa0f6,0x0d},
    {0xa0f7,0x60},
    {0xa0f8,0x9d},
    {0xa0f9,0x41},
    {0xa0fa,0x91},
    {0xa0fb,0xd1},
    {0xa0fc,0x05},
    {0xa0fd,0x01},
    {0xa0fe,0x31},
    {0xa0ff,0xe0},
    {0xa100,0x86},
    {0xa101,0x81},
    {0xa102,0x88},
    {0xa103,0x83},
    {0xa104,0x8b},
    {0xa105,0xe0},
    {0xa106,0x05},
    {0xa107,0x01},
    {0xa108,0x31},
    {0xa109,0xe0},
    {0xa10a,0x86},
    {0xa10b,0x81},
    {0xa10c,0x88},
    {0xa10d,0x83},
    {0xa10e,0x8c},
    {0xa10f,0x60},
    {0xa110,0x05},
    {0xa111,0x81},
    {0xa112,0x31},
    {0xa113,0xe0},
    {0xa114,0x86},
    {0xa115,0x81},
    {0xa116,0x88},
    {0xa117,0x83},
    {0xa118,0x0d},
    {0xa119,0xe0},
    {0xa11a,0x85},
    {0xa11b,0x01},
    {0xa11c,0xb1},
    {0xa11d,0xe0},
    {0xa11e,0x06},
    {0xa11f,0x01},
    {0xa120,0x88},
    {0xa121,0x83},
    {0xa122,0x90},
    {0xa123,0xe0},
    {0xa124,0x05},
    {0xa125,0x81},
    {0xa126,0xb6},
    {0xa127,0xe0},
    {0xa128,0x06},
    {0xa129,0x81},
    {0xa12a,0x08},
    {0xa12b,0x03},
    {0xa12c,0x8e},
    {0xa12d,0x90},
    {0xa12e,0x0a},
    {0xa12f,0x81},
    {0xa130,0x0d},
    {0xa131,0x9c},
    {0xa132,0x83},
    {0xa133,0x01},
    {0xa134,0x4e},
    {0xa135,0x1d},
    {0xa136,0xce},
    {0xa137,0x9c},
    {0xa138,0x09},
    {0xa139,0x80},
    {0xa13a,0x05},
    {0xa13b,0x01},
    {0xa13c,0x31},
    {0xa13d,0x60},
    {0xa13e,0x86},
    {0xa13f,0x01},
    {0xa140,0x90},
    {0xa141,0x61},
    {0xa142,0x08},
    {0xa143,0x01},
    {0xa144,0x88},
    {0xa145,0x00},
    {0xa146,0x9e},
    {0xa147,0x10},
    {0xa148,0x0c},
    {0xa149,0x01},
    {0xa14a,0x83},
    {0xa14b,0xa0},
    {0xa14c,0x0c},
    {0xa14d,0x19},
    {0xa14e,0x03},
    {0xa14f,0xa0},
    {0xa150,0x0c},
    {0xa151,0x99},
    {0xa152,0x88},
    {0xa153,0x80},
    {0xa154,0x03},
    {0xa155,0xad},
    {0xa156,0x01},
    {0xa157,0x2e},
    {0xa158,0x0b},
    {0xa159,0xac},
    {0xa15a,0x0b},
    {0xa15b,0xaf},
    {0xa15c,0x2e},
    {0xa15d,0xd1},
    {0xa15e,0x03},
    {0xa15f,0x83},
    {0xa160,0xaa},
    {0xa161,0xd1},
    {0xa162,0x00},
    {0xa163,0x80},

    {0x3583,0x00},
    {0x3584,0x2a},
    {0x0100,0x01},

    /* end of reg list */
    {REGLIST_END, 0x00},
};

static int enable(sensor_t *sensor)
{
    SCCB_Write_Reg16(sensor->slv_addr, 0x0100, 0x01);       /* enable stream */

    return 0;
}

static int disable(sensor_t *sensor)
{
    SCCB_Write_Reg16(sensor->slv_addr, 0x0100, 0x00);       /* disable stream */

    return 0;
}

static int set_exposure(sensor_t *sensor, BL_EXPO_TIME expo_time)
{
    return 0;
}

static int set_gain(sensor_t *sensor, BL_GAIN_DB gain)
{
    return 0;
}

static int set_flipmirror(sensor_t *sensor, FLIP_MIRROR_TYPE_E type)
{
    return 0;
}

static int set_fps(sensor_t *sensor, uint32_t fps)
{
    return 0;
}

static int setFmt(sensor_t *sensor)
{
    int i;
    FORMAT_INDEX format_index;
    const sensor_reg_16_8_t *init_reglist;

    switch (sensor->video_mode) {
    case VIDEO_MODE_1080P_30:
        format_index = FORMAT_INDEX_1080P_30;
        init_reglist = init_reglist_30fps;
        sensor->max_expo_time = EXPO_TIME_1_30_SEC;
        break;



    default:
        BL_LOGE("set_format error: invalid video mode!\r\n");
        return -1;
    }

    sensor->pix_clk         = format_info[format_index].pix_clk;
    sensor->fps             = format_info[format_index].fps;
    sensor->total_win.width     = format_info[format_index].total_width;
    sensor->total_win.height    = format_info[format_index].total_height;
    sensor->out_win.width = 1920;
    sensor->out_win.height = 1080;
    sensor->dsp2_out_win.width  = 1920;
    sensor->dsp2_out_win.height = 1080;

    for (i = 0; init_reglist[i].addr != REGLIST_END; i++) {
        SCCB_Write_Reg16(sensor->slv_addr, init_reglist[i].addr, (uint8_t)init_reglist[i].data);
    }

//    SCCB_Write_Reg16(sensor->slv_addr, REG_TOTAL_WIDTH_H, (uint8_t)(sensor->total_win.width >> 8));
//    SCCB_Write_Reg16(sensor->slv_addr, REG_TOTAL_WIDTH_L, (uint8_t)sensor->total_win.width);
//    SCCB_Write_Reg16(sensor->slv_addr, REG_TOTAL_HEIGHT_H, (uint8_t)(sensor->total_win.height >> 8));
//    SCCB_Write_Reg16(sensor->slv_addr, REG_TOTAL_HEIGHT_L, (uint8_t)sensor->total_win.height);


    return 0;
}

static int get_property(sensor_t *sensor, sensor_property_t *property)
{
    CHECK_PARAM(sensor != NULL);

    property->bayer_pattern = BAYER_PATTERN_BG;

    return 0;
}

static int probe(void)
{
    return sensor_probe(SLAVE_ADDR, REG_SENSOR_ID_H, REG_SENSOR_ID_L, SENSOR_ID_H, SENSOR_ID_L);
}

static int init(sensor_t *sensor)
{
    /* Initialize sensor structure */
    SENSOR_INIT_COMMON(C2496);

    //set_format(sensor, VIDEO_MODE_1080P_30);

    // SCCB_Write_Reg16(sensor->slv_addr, 0x3641, 0x1);        /* IO driver control */
    // SCCB_Write_Reg16(sensor->slv_addr, 0x3d08, 0x1);        /* invert the sensor pix clk polarity */
    // SCCB_Write_Reg16(sensor->slv_addr, 0x3640, 0x0);        /* pixel delay */

    return 0;
}

const BL_SENSOR_DESC_T sensor_desc_c2496 ATTR_SENSOR_DEVICE_TABLE =
{
    "C2496",
    SLAVE_ADDR,
    probe,
    init,
    setFmt,
};

