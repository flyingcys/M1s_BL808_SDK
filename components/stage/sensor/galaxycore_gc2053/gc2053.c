#include <bl808.h>
#include "sensor_internal.h"
#include "sccb.h"
#include <math.h>

/* GC2053 sensor info */
#define SLAVE_ADDR                  0x37
#define SENSOR_ID_H                 0x20
#define SENSOR_ID_L                 0x53
#define MIN_EXPO_TIME               143282                       /* 143282 ns, 4 line */
#define MAX_EXPO_TIME               EXPO_TIME_1_25_SEC          /* 1/25 sec */
#define REG_ADDR_BIT                SENSOR_REG_ADDR_8BIT

#define MAX_GAIN                    GAIN_DB_FLOAT_TO_INT(36)    /* limit max gain t0 36 dB to avoid bad noise */
#define MIN_GAIN_STEP               (GAIN_6_DB / 16)            /* 0.375 dB */

# define GAIN_BASE                  1000
/* GC2053 registers */
#define REG_SENSOR_ID_H             0xf0
#define REG_SENSOR_ID_L             0xf1

#define REG_PAGE_SELECT             0xfe

#define REG_ANALOG_PGA_GAIN_HIGH    0xb4
#define REG_ANALOG_PGA_GAIN_LOW     0xb3
#define REG_COL_GAIN_HIGH           0xb8
#define REG_COL_GAIN_LOW            0xb9
#define REG_AUTO_PREGAIN_SYNC       0xb1
#define REG_AUTO_PREGAIN            0xb2


#define REG_SHUTTER_TIME_H          0x03
#define REG_SHUTTER_TIME_L          0x04

#define REG_TOTAL_HEIGHT_H          0x41
#define REG_TOTAL_HEIGHT_L          0x42

#define REG_FLIP_MIRROR            0x17

typedef enum {
    FORMAT_INDEX_DVP_1080P_25 = 0,
    FORMAT_INDEX_MIPI_1_LANE_1080P_30,
    FORMAT_INDEX_MIPI_2_LANE_1080P_15,
    FORMAT_INDEX_MIPI_2_LANE_1080P_25,
    FORMAT_INDEX_MIPI_2_LANE_1080P_30,
    FORMAT_INDEX_MIPI_1_LANE_720P_30,
    FORMAT_INDEX_MIPI_2_LANE_720P_30,
    FORMAT_INDEX_MIPI_2_LANE_720P_60,
    FORMAT_INDEX_DVP_720P_60,
    FORMAT_INDEX_DVP_720P_30,
    FORMAT_INDEX_DVP_1080P_30,
    FORMAT_INDEX_INVALID,
} FORMAT_INDEX;

static fps_info_t fps_tbl = {0};

static const sensor_format_t format_info[] = {
    {   /*  DVP 1080p25 */
        .total_width    = 2640,
        .total_height   = 1125,
        .pix_clk        = 74250000,
        .fps            = 25,
        .bayer_pattern = BAYER_PATTERN_BG,
    },
    {   /*  MIPI 1lane 1080p30 */
        .total_width    = 2844,
        .total_height   = 1125,
        .pix_clk        = 81600000,
        .fps            = 30,
        .bayer_pattern = BAYER_PATTERN_BG,
    },
    {   /*  MIPI 2lane 1080p15  */
        .total_width    = 2200,
        .total_height   = 2250,
        .pix_clk        = 74400000,
        .fps            = 15,
        .bayer_pattern = BAYER_PATTERN_BG,
    },
    {   /*  MIPI 2lane 1080p25  */
        .total_width    = 2200,
        .total_height   = 1200,
        .pix_clk        = 66000000,
        .fps            = 25,
        .bayer_pattern = BAYER_PATTERN_BG,
    },
    {   /*  MIPI 2lane 1080p30  */
        .total_width    = 2200,
        .total_height   = 1125,
        .pix_clk        = 74250000,
        .fps            = 30,
        .bayer_pattern = BAYER_PATTERN_BG,
    },
    {   /*  MIPI 1lane 720p30 */
        .total_width    = 2200,
        .total_height   = 1125,
        .pix_clk        = 74250000,
        .fps            = 30,
        .bayer_pattern = BAYER_PATTERN_GR,
    },
    {   /*  MIPI 2lane 720p30 */
        .total_width    = 2200,
        .total_height   = 1125,
        .pix_clk        = 74250000,
        .fps            = 30,
        .bayer_pattern = BAYER_PATTERN_GR,
    },
    {   /*  MIPI 2lane 720p60 */
        .total_width    = 1896,
        .total_height   = 765,
        .pix_clk        = 87026400,
        .fps            = 60,
        .bayer_pattern = BAYER_PATTERN_GR,
    },
    {   /*  DVP 720p60  */
        .total_width    = 2200,
        .total_height   = 1125,
        .pix_clk        = 74250000,
        .fps            = 60,
        .bayer_pattern = BAYER_PATTERN_RG,
    },
    {   /*  DVP 720p30  */
        .total_width    = 2200,
        .total_height   = 1125,
        .pix_clk        = 74250000,
        .fps            = 30,
        .bayer_pattern = BAYER_PATTERN_BG,
    },
    {   /*  DVP 1080p30 */
        .total_width    = 2200,
        .total_height   = 1125,
        .pix_clk        = 74250000,
        .fps            = 30,
        .bayer_pattern = BAYER_PATTERN_BG,
    },
};

static const int gc2053_mode[] = {\
    DSP2_INPUT_DVP,\
    DSP2_INPUT_MIPI_1LANE,\
    DSP2_INPUT_MIPI_2LANE,\
};

static const sensor_reg_16_8_t init_reglist_MIPI_1lane_1080p_30fps[] = {
// 1lane 816M
{0xfe,0x80},
{0xfe,0x80},
{0xfe,0x80},
{0xfe,0x00},
{0xf2,0x00},
{0xf3,0x00},
{0xf4,0x36},
{0xf5,0xc0},
{0xf6,0x81},
{0xf7,0x01},
{0xf8,0x22},
{0xf9,0x80},
{0xfc,0x8e},
{0xfe,0x00},
{0x87,0x18},
{0xee,0x30},
{0xd0,0xb7},
{0x03,0x04},
{0x04,0x10},
{0x05,0x04},
{0x06,0xb8},
{0x07,0x00},
{0x08,0x08},
{0x09,0x00},
{0x0a,0x02},
{0x0b,0x00},
{0x0c,0x02},
{0x0d,0x04},
{0x0e,0x40},
{0x12,0xe2},
{0x13,0x16},
{0x19,0x0a},
{0x21,0x1c},
{0x28,0x0a},
{0x29,0x24},
{0x2b,0x04},
{0x32,0xf8},
{0x37,0x03},
{0x39,0x15},
{0x43,0x07},
{0x44,0x40},
{0x46,0x0b},
{0x4b,0x20},
{0x4e,0x08},
{0x55,0x20},
{0x66,0x05},
{0x67,0x05},
{0x77,0x01},
{0x78,0x00},
{0x7c,0x93},
{0x8c,0x12},
{0x8d,0x92},
{0x90,0x01},
{0x9d,0x10},
{0xce,0x7c},
{0xd2,0x41},
{0xd3,0xdc},
{0xda,0x05},
{0xdb,0x00},
{0xe6,0x50},
{0xb6,0xc0},
{0xb0,0x70},
{0xb1,0x01},
{0xb2,0x00},
{0xb3,0x00},
{0xb4,0x00},
{0xb8,0x01},
{0xb9,0x00},
{0x26,0x30},
{0xfe,0x01},
{0x40,0x23},
{0x55,0x07},
{0x60,0x40},
{0xfe,0x04},
{0x14,0x78},
{0x15,0x78},
{0x16,0x78},
{0x17,0x78},
{0xfe,0x01},
{0x92,0x01},
{0x94,0x04},
{0x95,0x04},
{0x96,0x38},
{0x97,0x07},
{0x98,0x80},
{0xfe,0x01},
{0x01,0x05},
{0x02,0x89},
{0x04,0x00},//DD_en
{0x07,0xa6},
{0x08,0xa9},
{0x09,0xa8},
{0x0a,0xa7},
{0x0b,0xff},
{0x0c,0xff},
{0x0f,0x00},
{0x50,0x1c},
{0x89,0x03},
{0xfe,0x04},
{0x28,0x86},
{0x29,0x86},
{0x2a,0x86},
{0x2b,0x68},
{0x2c,0x68},
{0x2d,0x68},
{0x2e,0x68},
{0x2f,0x68},
{0x30,0x4f},
{0x31,0x68},
{0x32,0x67},
{0x33,0x66},
{0x34,0x66},
{0x35,0x66},
{0x36,0x66},
{0x37,0x66},
{0x38,0x62},
{0x39,0x62},
{0x3a,0x62},
{0x3b,0x62},
{0x3c,0x62},
{0x3d,0x62},
{0x3e,0x62},
{0x3f,0x62},
{0xfe,0x01},
{0x9a,0x06},
{0xfe,0x00},
{0x7b,0x2a},
{0x23,0x2d},
{0xfe,0x03},
{0x01,0x27},
{0x02,0x56},
// {0x03,0xb6},
 {0x03,0x8e},
{0x12,0x80},
{0x13,0x07},
{0x15,0x12},
    /* end of reg list */
    {REGLIST_END, 0x00},
};


static const sensor_reg_16_8_t init_reglist_MIPI_1lane_720p_30fps[] __attribute__((unused)) = {
// 1lane 816M
{0xfe,0x80},
{0xfe,0x80},
{0xfe,0x80},
{0xfe,0x00},
{0xf2,0x00},
{0xf3,0x00},
{0xf4,0x36},
{0xf5,0xc0},
{0xf6,0x81},
{0xf7,0x01},
{0xf8,0x22},
{0xf9,0x80},
{0xfc,0x8e},
{0xfe,0x00},
{0x87,0x18},
{0xee,0x30},
{0xd0,0xb7},
{0x03,0x04},
{0x04,0x10},
{0x05,0x04},
{0x06,0xb8},
{0x07,0x00},
{0x08,0x08},
{0x09,0x00},
{0x0a,0x02},
{0x0b,0x00},
{0x0c,0x02},
{0x0d,0x04},
{0x0e,0x40},
{0x12,0xe2},
{0x13,0x16},
{0x19,0x0a},
{0x21,0x1c},
{0x28,0x0a},
{0x29,0x24},
{0x2b,0x04},
{0x32,0xf8},
{0x37,0x03},
{0x39,0x15},
{0x43,0x07},
{0x44,0x40},
{0x46,0x0b},
{0x4b,0x20},
{0x4e,0x08},
{0x55,0x20},
{0x66,0x05},
{0x67,0x05},
{0x77,0x01},
{0x78,0x00},
{0x7c,0x93},
{0x8c,0x12},
{0x8d,0x92},
{0x90,0x01},
{0x9d,0x10},
{0xce,0x7c},
{0xd2,0x41},
{0xd3,0xdc},
{0xda,0x05},
{0xdb,0x00},
{0xe6,0x50},
{0xb6,0xc0},
{0xb0,0x70},
{0xb1,0x01},
{0xb2,0x00},
{0xb3,0x00},
{0xb4,0x00},
{0xb8,0x01},
{0xb9,0x00},
{0x26,0x30},
{0xfe,0x01},
{0x40,0x23},
{0x55,0x07},
{0x60,0x40},
{0xfe,0x04},
{0x14,0x78},
{0x15,0x78},
{0x16,0x78},
{0x17,0x78},
{0xfe,0x01},
{0x91,0x01},
{0x92,0x68},
{0x93,0x01},
{0x94,0x40},
{0x95,0x02},
{0x96,0xd0},
{0x97,0x05},
{0x98,0x00},
{0xfe,0x01},
{0x01,0x05},
{0x02,0x89},
{0x04,0x00},//DD_en
{0x07,0xa6},
{0x08,0xa9},
{0x09,0xa8},
{0x0a,0xa7},
{0x0b,0xff},
{0x0c,0xff},
{0x0f,0x00},
{0x50,0x1c},
{0x89,0x03},
{0xfe,0x04},
{0x28,0x86},
{0x29,0x86},
{0x2a,0x86},
{0x2b,0x68},
{0x2c,0x68},
{0x2d,0x68},
{0x2e,0x68},
{0x2f,0x68},
{0x30,0x4f},
{0x31,0x68},
{0x32,0x67},
{0x33,0x66},
{0x34,0x66},
{0x35,0x66},
{0x36,0x66},
{0x37,0x66},
{0x38,0x62},
{0x39,0x62},
{0x3a,0x62},
{0x3b,0x62},
{0x3c,0x62},
{0x3d,0x62},
{0x3e,0x62},
{0x3f,0x62},
{0xfe,0x01},
{0x9a,0x06},
{0xfe,0x00},
{0x7b,0x2a},
{0x23,0x2d},
{0xfe,0x03},
{0x01,0x27},
{0x02,0x56},
// {0x03,0xb6},
 {0x03,0x8e},
{0x12,0x80},
{0x13,0x07},
{0x15,0x12},
    /* end of reg list */
{REGLIST_END, 0x00},
};        
          
static const sensor_reg_16_8_t init_reglist_MIPI_2lane_1080p_15fps[] =
{
    //release_V1_GC2053_MIPI_2lane_base24M_30fps_1920x1080->cheng 0x41, 0x42
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x00},
    {0xf2,0x00},
    {0xf3,0x00},
    {0xf4,0x36},
    {0xf5,0xc0},
    {0xf6,0x84},
    {0xf7,0x11},
    {0xf8,0x3e},
    {0xf9,0x82},
    {0xfc,0x8e},
    
    {0xfe,0x00},
    {0x87,0x18},
    {0xee,0x30},
    {0xd0,0xb7},
    {0x03,0x04},
    {0x04,0x60},
    {0x05,0x04},
    {0x06,0x4c},
    {0x07,0x00},
    {0x08,0x11},
    {0x09,0x00},
    {0x0a,0x02},
    {0x0b,0x00},
    {0x0c,0x02},
    {0x0d,0x04},
    {0x0e,0x40},
    {0x12,0xe2},
    {0x13,0x16},
    {0x19,0x0a},
    {0x21,0x1c},
    {0x28,0x0a},
    {0x29,0x24},
    {0x2b,0x04},
    {0x32,0xf8},
    {0x37,0x03},
    {0x39,0x15},
    {0x43,0x07},
    {0x44,0x40},
    {0x46,0x0b},
    {0x4b,0x20},
    {0x4e,0x08},
    {0x55,0x20},
    {0x66,0x05},
    {0x67,0x05},
    {0x77,0x01},
    {0x78,0x00},
    {0x7c,0x93},
    {0x8c,0x12},
    {0x8d,0x92},
    {0x90,0x00},
    {0x41,0x08},//frame length
    {0x42,0xca},
    {0x9d,0x10},
    {0xce,0x7c},
    {0xd2,0x41},
    {0xd3,0xdc},
    {0xe6,0x50},
    
    {0xb6,0xc0},
    {0xb0,0x70},
    {0xb1,0x01},
    {0xb2,0x00},
    {0xb3,0x00},
    {0xb4,0x00},
    {0xb8,0x01},
    {0xb9,0x00},
    
    {0x26,0x30},
    {0xfe,0x01},
    {0x40,0x23},
    {0x55,0x07},
    {0x60,0x40},
    {0xfe,0x04},
    {0x14,0x78},
    {0x15,0x78},
    {0x16,0x78},
    {0x17,0x78},
    
    {0xfe,0x01},
    {0x92,0x01},
    {0x94,0x04},
    {0x95,0x04},
    {0x96,0x38},
    {0x97,0x07},
    {0x98,0x80},
    /*skip frame*/
    {0xfe,0x01},
    {0x83,0x01},
    {0x87,0x50},//0x50, skip 0, default:0x53,skip 3
    {0xfe,0x00},
    
    {0xfe,0x01},
    {0x01,0x05},
    {0x02,0x89},
    {0x04,0x00},//DD_en
    {0x07,0xa6},
    {0x08,0xa9},
    {0x09,0xa8},
    {0x0a,0xa7},
    {0x0b,0xff},
    {0x0c,0xff},
    {0x0f,0x00},
    {0x50,0x1c},
    {0x89,0x03},
    {0xfe,0x04},
    {0x28,0x86},
    {0x29,0x86},
    {0x2a,0x86},
    {0x2b,0x68},
    {0x2c,0x68},
    {0x2d,0x68},
    {0x2e,0x68},
    {0x2f,0x68},
    {0x30,0x4f},
    {0x31,0x68},
    {0x32,0x67},
    {0x33,0x66},
    {0x34,0x66},
    {0x35,0x66},
    {0x36,0x66},
    {0x37,0x66},
    {0x38,0x62},
    {0x39,0x62},
    {0x3a,0x62},
    {0x3b,0x62},
    {0x3c,0x62},
    {0x3d,0x62},
    {0x3e,0x62},
    {0x3f,0x62},
    
    {0xfe,0x01},
    {0x9a,0x06},
    {0xfe,0x00},
    {0x7b,0x2a},
    {0x23,0x2d},
    {0xfe,0x03},
    {0x01,0x27},
    {0x02,0x56},
    {0x03,0x8e},// default is 0xb6
    {0x12,0x80},
    {0x13,0x07},
    {0x15,0x10},
    {0xfe,0x00},
    {0x3e,0x91},

    {REGLIST_END, 0x00},
};


static const sensor_reg_16_8_t init_reglist_MIPI_2lane_1080p_25fps[] =
{
{0xfe,0x80},
{0xfe,0x80},
{0xfe,0x80},
{0xfe,0x00},
{0xf2,0x00},
{0xf3,0x00},
{0xf4,0x36},
{0xf5,0xc0},
{0xf6,0x84},
{0xf7,0x11},
{0xf8,0x37},
{0xf9,0x82},
{0xfc,0x8e},

{0xfe,0x00},
{0x87,0x18},
{0xee,0x30},
{0xd0,0xb7},
{0x03,0x04},
{0x04,0x60},
{0x05,0x04},
{0x06,0x4c},
{0x07,0x00},
{0x08,0x64},
{0x09,0x00},
{0x0a,0x02},
{0x0b,0x00},
{0x0c,0x02},
{0x0d,0x04},
{0x0e,0x40},
{0x12,0xe2},
{0x13,0x16},
{0x19,0x0a},
{0x21,0x1c},
{0x28,0x0a},
{0x29,0x24},
{0x2b,0x04},
{0x32,0xf8},
{0x37,0x03},
{0x39,0x15},
{0x43,0x07},
{0x44,0x40},
{0x46,0x0b},
{0x4b,0x20},
{0x4e,0x08},
{0x55,0x20},
{0x66,0x05},
{0x67,0x05},
{0x77,0x01},
{0x78,0x00},
{0x7c,0x93},
{0x8c,0x12},
{0x8d,0x92},
{0x90,0x00},
{0x41,0x04},
{0x42,0xb0},
{0x9d,0x10},
{0xce,0x7c},
{0xd2,0x41},
{0xd3,0xdc},
{0xe6,0x50},

{0xb6,0xc0},
{0xb0,0x70},
{0xb1,0x01},
{0xb2,0x00},
{0xb3,0x00},
{0xb4,0x00},
{0xb8,0x01},
{0xb9,0x00},

{0x26,0x30},
{0xfe,0x01},
{0x40,0x23},
{0x55,0x07},
{0x60,0x40},
{0xfe,0x04},
{0x14,0x78},
{0x15,0x78},
{0x16,0x78},
{0x17,0x78},

{0xfe,0x01},
{0x92,0x01},
{0x94,0x04},
{0x95,0x04},
{0x96,0x38},
{0x97,0x07},
{0x98,0x80},
/*skip frame*/
{0xfe,0x01},
{0x83,0x01},
{0x87,0x50},//0x50, skip 0, default:0x53,skip 3
{0xfe,0x00},

{0xfe,0x01},
{0x01,0x05},
{0x02,0x89},
{0x04,0x00},//DD_en
{0x07,0xa6},
{0x08,0xa9},
{0x09,0xa8},
{0x0a,0xa7},
{0x0b,0xff},
{0x0c,0xff},
{0x0f,0x00},
{0x50,0x1c},
{0x89,0x03},
{0xfe,0x04},
{0x28,0x86},
{0x29,0x86},
{0x2a,0x86},
{0x2b,0x68},
{0x2c,0x68},
{0x2d,0x68},
{0x2e,0x68},
{0x2f,0x68},
{0x30,0x4f},
{0x31,0x68},
{0x32,0x67},
{0x33,0x66},
{0x34,0x66},
{0x35,0x66},
{0x36,0x66},
{0x37,0x66},
{0x38,0x62},
{0x39,0x62},
{0x3a,0x62},
{0x3b,0x62},
{0x3c,0x62},
{0x3d,0x62},
{0x3e,0x62},
{0x3f,0x62},

{0xfe,0x01},
    // {0x8c,0x01}, // test mode
{0x9a,0x06},
{0xfe,0x00},
{0x7b,0x2a},
// {0x22,0x0a}, // jz tmp
{0x23,0x2d},
{0xfe,0x03},
{0x01,0x27},
{0x02,0x56},
// {0x03,0xb6}, // default is 0xb6
    {0x03,0x8e},
{0x12,0x80},
{0x13,0x07},
{0x15,0x12},
    {REGLIST_END, 0x00},
};

static const sensor_reg_16_8_t init_reglist_MIPI_2lane_1080p_30fps[] =
{
    //release_V1_GC2053_MIPI_2lane_base24M_30fps_1920x1080
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x00},
    {0xf2,0x00},
    {0xf3,0x00},
    {0xf4,0x36},
    {0xf5,0xc0},
    {0xf6,0x84},
    {0xf7,0x11},
    {0xf8,0x3e},
    {0xf9,0x82},
    {0xfc,0x8e},
    
    {0xfe,0x00},
    {0x87,0x18},
    {0xee,0x30},
    {0xd0,0xb7},
    {0x03,0x04},
    {0x04,0x60},
    {0x05,0x04},
    {0x06,0x4c},
    {0x07,0x00},
    {0x08,0x11},
    {0x09,0x00},
    {0x0a,0x02},
    {0x0b,0x00},
    {0x0c,0x02},
    {0x0d,0x04},
    {0x0e,0x40},
    {0x12,0xe2},
    {0x13,0x16},
    {0x19,0x0a},
    {0x21,0x1c},
    {0x28,0x0a},
    {0x29,0x24},
    {0x2b,0x04},
    {0x32,0xf8},
    {0x37,0x03},
    {0x39,0x15},
    {0x43,0x07},
    {0x44,0x40},
    {0x46,0x0b},
    {0x4b,0x20},
    {0x4e,0x08},
    {0x55,0x20},
    {0x66,0x05},
    {0x67,0x05},
    {0x77,0x01},
    {0x78,0x00},
    {0x7c,0x93},
    {0x8c,0x12},
    {0x8d,0x92},
    {0x90,0x00},
    {0x41,0x04},
    {0x42,0x65},
    {0x9d,0x10},
    {0xce,0x7c},
    {0xd2,0x41},
    {0xd3,0xdc},
    {0xe6,0x50},
    
    {0xb6,0xc0},
    {0xb0,0x70},
    {0xb1,0x01},
    {0xb2,0x00},
    {0xb3,0x00},
    {0xb4,0x00},
    {0xb8,0x01},
    {0xb9,0x00},
    
    {0x26,0x30},
    {0xfe,0x01},
    {0x40,0x23},
    {0x55,0x07},
    {0x60,0x40},
    {0xfe,0x04},
    {0x14,0x78},
    {0x15,0x78},
    {0x16,0x78},
    {0x17,0x78},
    
    {0xfe,0x01},
    {0x92,0x01},
    {0x94,0x04},
    {0x95,0x04},
    {0x96,0x38},
    {0x97,0x07},
    {0x98,0x80},
    /*skip frame*/
    {0xfe,0x01},
    {0x83,0x01},
    {0x87,0x50},//0x50, skip 0, default:0x53,skip 3
    {0xfe,0x00},
    
    {0xfe,0x01},
    {0x01,0x05},
    {0x02,0x89},
    {0x04,0x00},//DD_en
    {0x07,0xa6},
    {0x08,0xa9},
    {0x09,0xa8},
    {0x0a,0xa7},
    {0x0b,0xff},
    {0x0c,0xff},
    {0x0f,0x00},
    {0x50,0x1c},
    {0x89,0x03},
    {0xfe,0x04},
    {0x28,0x86},
    {0x29,0x86},
    {0x2a,0x86},
    {0x2b,0x68},
    {0x2c,0x68},
    {0x2d,0x68},
    {0x2e,0x68},
    {0x2f,0x68},
    {0x30,0x4f},
    {0x31,0x68},
    {0x32,0x67},
    {0x33,0x66},
    {0x34,0x66},
    {0x35,0x66},
    {0x36,0x66},
    {0x37,0x66},
    {0x38,0x62},
    {0x39,0x62},
    {0x3a,0x62},
    {0x3b,0x62},
    {0x3c,0x62},
    {0x3d,0x62},
    {0x3e,0x62},
    {0x3f,0x62},
    
    {0xfe,0x01},
    {0x9a,0x06},
    {0xfe,0x00},
    {0x7b,0x2a},
    {0x23,0x2d},
    {0xfe,0x03},
    {0x01,0x27},
    {0x02,0x56},
    {0x03,0x8e},// default is 0xb6
    {0x12,0x80},
    {0x13,0x07},
    {0x15,0x10},
    {0xfe,0x00},
    {0x3e,0x91},

    {REGLIST_END, 0x00},
};


static const sensor_reg_16_8_t init_reglist_25fps[] =
{
    {0xfe,0x80}, // page select
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x10},
    {0xf2,0x00}, // [7] OTP_clk_gate [6:4] OTP_mode_temp [1] I2C_open_ena [0]pwd_dn
    {0xf3,0x0f}, // [7] OTP_finish [6] OTP_busy [5] Spad_vb_hiz_mode [4] Spad_buf_mode [3] Sdata_pad_io [2:0] Ssync_pad_io
    {0xf4,0x36}, // [7] reduce_power_mode, [6:4]PLL_ldo_set, [3:0]spi_clk_div
    {0xf5,0xc0}, // [7] soc_mclk_enable, [6] pll_ldo_en, [5:4]cp_clk_del, [3:0]cp_clk_div
    {0xf6,0x44}, // [7:3]wpllclk_div, [2:0]refmp_div
    {0xf7,0x01}, // [7]refdiv2d5_en [6]refdiv1d5_en [5:4]scaler_mode(dvpmode) [3]refmp_enb [2]freq div2 [1]div2en [0]pll_en
    {0xf8,0x63}, // [7:0]pllmp_div
    {0xf9,0x40}, // [7:3]rpllclk_div [2:1]pllmp_prediv [0]analog_pwc
    {0xfc,0x8e}, // [7] regf clk enable [6] sys_rclk_sel [5] sys_wclk_sel [4:3]spi_sel_mode [2] serail_clk enable [1] re_lock_pll [0] not_use_pll
    /*cisctl&analog*/

    {0xfe,0x10},
    {0x87,0x18}, // Debug_mode disable
    {0xee,0x30},
    {0xd0,0xb7},
    {0x03,0x01},
    {0x04,0x19},
    {0x05,0x05}, // Line length = 1320 *2   [3:0] Line length[11:8] X2
    {0x06,0x28}, //                         [7:0] Line length[7:0]  X2
    {0x07,0x00},
    {0x08,0x11},
    {0x09,0x00}, // row start
    {0x0a,0x02},
    {0x0b,0x00}, // col start
    {0x0c,0x02},
    {0x0d,0x04}, // valid line time:Window width 1088
                 // Windows height default is 1936
    {0x0e,0x40},
    {0x12,0xe2},
    {0x13,0x16},
    {0x19,0x0a},
    {0x21,0x1c},
    {0x28,0x0a},
    {0x29,0x24},
    {0x2b,0x04},
    {0x32,0xf8},
    {0x37,0x03},
    {0x39,0x15},
    {0x43,0x07},
    {0x44,0x40},
    {0x46,0x0b},
    {0x4b,0x20},
    {0x4e,0x08},
    {0x55,0x20},
    {0x66,0x05},
    {0x67,0x05},
    {0x77,0x01},
    {0x78,0x00},
    {0x7c,0x93},
    {0x8c,0x12},
    {0x8d,0x92},
    {0x90,0x00},//
    {0x41,0x04},
    {0x42,0x60},
    {0x9d,0x10},
    {0xce,0x7c},
    {0xd2,0x41},
    {0xd3,0xdc},
    {0xe6,0x50},
    /*gain*/
    {0xb6,0xc0},
    {0xb0,0x70},
    {0xb1,0x01},
    {0xb2,0x14},
    {0xb3,0x30},
    {0xb4,0x00},
    {0xb8,0x01},
    {0xb9,0x2c},
    /*blk*/
    {0x26,0x30},
    {0xfe,0x11},
    {0x40,0x23}, // BLK_mode1. [7] not smooth [6:4] blk_smooth_speed [3]blk_dd_map [2]dark_sel_map [1]dark_current_en [0]offset_en
    {0x55,0x07},
    {0x60,0x40}, // DARK OFFSET
    {0xfe,0x14},
    {0x14,0x78}, // Ndark_ratio_G1
    {0x15,0x78}, // Ndark_ratio_R1
    {0x16,0x78}, // Ndark_ratio_B2
    {0x17,0x78}, // Ndark_ratio_G2
    /*window*/
    {0xfe,0x11},
    {0x92,0x01}, // output win start y
    {0x94,0x04}, // output win start x
    {0x95,0x04}, // output win height 1080
    {0x96,0x38},
    {0x97,0x07}, // outout win width  1920
    {0x98,0x80},
    /*skip frame*/
    {0xfe,0x11},
    {0x87,0x50},
    /*DSP2*/
    {0xfe,0x11},
    {0x01,0x05},
    {0x02,0x89},
    {0x04,0x00},//DD_en
    {0x07,0xa6},
    {0x08,0xa9},
    {0x09,0xa8},
    {0x0a,0xa7},
    {0x0b,0xff},
    {0x0c,0xff},
    {0x0f,0x00},
    {0x50,0x1c},
    {0x89,0x03},
    {0xfe,0x14},
    {0x28,0x86},
    {0x29,0x86},
    {0x2a,0x86},
    {0x2b,0x68},
    {0x2c,0x68},
    {0x2d,0x68},
    {0x2e,0x68},
    {0x2f,0x68},
    {0x30,0x4f},
    {0x31,0x68},
    {0x32,0x67},
    {0x33,0x66},
    {0x34,0x66},
    {0x35,0x66},
    {0x36,0x66},
    {0x37,0x66},
    {0x38,0x62},
    {0x39,0x62},
    {0x3a,0x62},
    {0x3b,0x62},
    {0x3c,0x62},
    {0x3d,0x62},
    {0x3e,0x62},
    {0x3f,0x62},

    /****DVP & MIPI****/
    {0xfe,0x11},
    // {0x8c,0x01}, // test mode
    //{0x9a,0x06},    /* VSYNC low pulse */
    {0x9a,0x02},      /* VSYNC high pulse */
    {0xfe,0x10},
    {0x7b,0x2b},
    {0x23,0x2d},
    {0xfe,0x13},
    {0x01,0x20}, // DPHY_analog_mode1
    {0x02,0x56}, // DPHY_analog_mode2
    {0x03,0xb2}, // DPHY_analog_mode3
    {0x12,0x80}, // LWC_set[7:0]
    {0x13,0x07}, // LWC_set[15:8]

    {0xfe,0x11},
    {0x8c,0x90},
    {0xfe,0x10},
    {0x3e,0x00},

    /* end of reg list */
    {REGLIST_END, 0x00},
};

static const sensor_reg_16_8_t init_reglist_720p_60fps[] =
{
#if 0
    {0xff,0x07},
    {0x04,0x00},
    {0x16,0x12},

    {0x14,0x2b},
    {0x20,0x3d}, //reset low, mclk enable, powndown high

    sleep 100
    {0x20,0x3f}, //reset high, mclk enable, powndown high
    {0xff,0x6e}, //8 addr 8 data
#endif
    /*system*/
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x00},
    {0xf2,0x00},
    {0xf3,0x0f},
    {0xf4,0x36},
    {0xf5,0xc0},
    {0xf6,0x23},
    {0xf7,0x01},
    {0xf8,0x24},
    {0xf9,0x42},
    {0xfc,0x8e},

    /*cisctl&analog*/
    {0xfe,0x00},
    {0x87,0x18},
    {0xee,0x30},
    {0xd0,0xb7},

    {0x03,0x02},
    {0x04,0xd0},
    {0x05,0x04},
    {0x06,0x01},
    {0x07,0x00},
    {0x08,0x11},
    {0x09,0x00},
    {0x0a,0x9a},
    {0x0b,0x01},
    {0x0c,0x40},
    {0x0d,0x02},
    {0x0e,0xe7},
    {0x0f,0x05},
    {0x10,0x14},
    {0x12,0xe2},
    {0x13,0x16},
    {0x19,0x0a},
    {0x21,0x1c},
    {0x28,0x0a},
    {0x29,0x24},
    {0x2b,0x04},
    {0x32,0xf8},
    {0x37,0x03},
    {0x39,0x15},
    {0x43,0x07},
    {0x44,0x40},
    {0x46,0x0b},
    {0x4b,0x20},
    {0x4e,0x08},
    {0x55,0x20},
    {0x66,0x05},
    {0x67,0x05},
    {0x77,0x00},
    {0x78,0x20},
    {0x7c,0x93},
    {0x8c,0x12},
    {0x8d,0x90},
    {0x9d,0x10},
    {0xce,0x7c},
    {0xd2,0x41},
    {0xd3,0xdc},
    {0xe6,0x50},
    {0x44,0x20},

    /*gain*/
    {0xb6,0xc0},
    {0xb0,0x70},
    {0xb1,0x01},
    {0xb2,0x00},
    {0xb3,0x00},
    {0xb4,0x00},
    {0xb8,0x01},
    {0xb9,0x00},

    /*blk*/
    {0x26,0x30},
    {0xfe,0x01},
    {0x40,0x23},
    {0x55,0x07},
    {0x60,0x40},
    {0xfe,0x04},
    {0x14,0x78},
    {0x15,0x78},
    {0x16,0x78},
    {0x17,0x78},


    /*window*/
    {0xfe,0x01},
    {0x92,0x00},
    {0x94,0x03},
    {0x95,0x02},
    {0x96,0xd0},
    {0x97,0x05},
    {0x98,0x00},

    /*DSP2*/
    {0xfe,0x01},
    {0x01,0x05},
    {0x02,0x89},
    {0x04,0x00},//DD_en
    {0x07,0xa6},
    {0x08,0xa9},
    {0x09,0xa8},
    {0x0a,0xa7},
    {0x0b,0xff},
    {0x0c,0xff},
    {0x0f,0x00},
    {0x50,0x1c},
    {0x89,0x03},

    {0xfe,0x04},
    {0x28,0x86},//84
    {0x29,0x86},//84
    {0x2a,0x86},//84
    {0x2b,0x68},//84
    {0x2c,0x68},//84
    {0x2d,0x68},//84
    {0x2e,0x68},//83
    {0x2f,0x68},//82

    {0x30,0x4f},//82
    {0x31,0x68},//82
    {0x32,0x67},//82
    {0x33,0x66},//82
    {0x34,0x66},//82
    {0x35,0x66},//82
    {0x36,0x66},//64
    {0x37,0x66},//68

    {0x38,0x62},
    {0x39,0x62},
    {0x3a,0x62},
    {0x3b,0x62},
    {0x3c,0x62},
    {0x3d,0x62},
    {0x3e,0x62},
    {0x3f,0x62},

    /****DVP & MIPI****/
    {0xfe,0x01},
    {0x9a,0x06},
    {0xfe,0x00},
    {0x7b,0x2a},
    {0x23,0x2d},
    {0xfe,0x03},
    {0x01,0x20},
    {0x02,0x56},
    {0x03,0xb2},
    {0x12,0x00},
    {0x13,0x05},
    {0xfe,0x00},
    {0x3e,0x40},

    /* end of reg list */
    {REGLIST_END, 0x00},

};

static const sensor_reg_16_8_t init_reglist_720p_30fps[] =
{
    //window_size=1280*720
    //mclk=24mhz,pclk=74.25mhz
    //pixel_line_total=2200,line_frame_total=1125
    //row_time=29.629us,frame_rate=30fps
    /****system****/
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x00},
    {0xf2,0x00},
    {0xf3,0x0f},
    {0xf4,0x36},
    {0xf5,0xc0},
    {0xf6,0x44},
    {0xf7,0x01},
    {0xf8,0x63},
    {0xf9,0x40},
    {0xfc,0x8e},
    /****CISCTL & ANALOG****/
    {0xfe,0x00},
    {0x87,0x18},
    {0xee,0x30},
    {0xd0,0xb7},
    {0x03,0x04},
    {0x04,0x60},
    {0x05,0x04},
    {0x06,0x4c},
    {0x07,0x00},
    {0x08,0x11},
    {0x09,0x00},
    {0x0a,0x02},
    {0x0b,0x00},
    {0x0c,0x02},
    {0x0d,0x04},
    {0x0e,0x40},
    {0x12,0xe2},
    {0x13,0x16},
    {0x19,0x0a},
    {0x21,0x1c},
    {0x28,0x0a},
    {0x29,0x24},
    {0x2b,0x04},
    {0x32,0xf8},
    {0x37,0x03},
    {0x39,0x15},
    {0x43,0x07},
    {0x44,0x40},
    {0x46,0x0b},
    {0x4b,0x20},
    {0x4e,0x08},
    {0x55,0x20},
    {0x66,0x05},
    {0x67,0x05},
    {0x77,0x01},
    {0x78,0x00},
    {0x7c,0x93},
    {0x8c,0x12},
    {0x8d,0x92},
    {0x90,0x00},
    {0x9d,0x10},
    {0xce,0x7c},
    {0xd2,0x41},
    {0xd3,0xdc},
    {0xe6,0x50},
    /*gain*/
    {0xb6,0xc0},
    {0xb0,0x70},
    {0xb1,0x01},
    {0xb2,0x00},
    {0xb3,0x00},
    {0xb4,0x00},
    {0xb8,0x01},
    {0xb9,0x00},
    /*blk*/
    {0x26,0x30},
    {0xfe,0x01},
    {0x40,0x23},
    {0x55,0x07},
    {0x60,0x40},
    {0xfe,0x04},
    {0x14,0x78},
    {0x15,0x78},
    {0x16,0x78},
    {0x17,0x78},
    /*window*/
    {0xfe,0x01},
    {0x91,0x00},//win start y
    {0x92,0xB3},
    {0x93,0x01},//win start x
    {0x94,0x42},
    {0x95,0x02},
    {0x96,0xd0},
    {0x97,0x05},
    {0x98,0x00},
    /*DSP2*/
    {0xfe,0x01},
    {0x01,0x05},
    {0x02,0x89},
    {0x04,0x00},//DD_en
    {0x07,0xa6},
    {0x08,0xa9},
    {0x09,0xa8},
    {0x0a,0xa7},
    {0x0b,0xff},
    {0x0c,0xff},
    {0x0f,0x00},
    {0x50,0x1c},
    {0x89,0x03},
    {0xfe,0x04},
    {0x28,0x86},
    {0x29,0x86},
    {0x2a,0x86},
    {0x2b,0x68},
    {0x2c,0x68},
    {0x2d,0x68},
    {0x2e,0x68},
    {0x2f,0x68},
    {0x30,0x4f},
    {0x31,0x68},
    {0x32,0x67},
    {0x33,0x66},
    {0x34,0x66},
    {0x35,0x66},
    {0x36,0x66},
    {0x37,0x66},
    {0x38,0x62},
    {0x39,0x62},
    {0x3a,0x62},
    {0x3b,0x62},
    {0x3c,0x62},
    {0x3d,0x62},
    {0x3e,0x62},
    {0x3f,0x62},
    /****DVP & MIPI****/
    {0xfe,0x01},
    {0x9a,0x06},
    {0xfe,0x00},
    {0x7b,0x2a},
    {0x23,0x2d},
    {0xfe,0x03},
    {0x01,0x20},
    {0x02,0x56},
    {0x03,0xb2},
    {0x12,0x80},
    {0x13,0x07},
    {0xfe,0x00},
    {0x3e,0x40},

    /* end of reg list */
    {REGLIST_END, 0x00},
};

static const sensor_reg_16_8_t init_reglist_30fps[] =
{
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x00},
    {0xf2,0x00},
    {0xf3,0x0f},
    {0xf4,0x36},
    {0xf5,0xc0},
    {0xf6,0x44},
    {0xf7,0x01},
    {0xf8,0x63},
    {0xf9,0x40},
    {0xfc,0x8e},
    /*cisctl&analog*/
    
    {0xfe,0x00},
    {0x87,0x18},
    {0xee,0x30},
    {0xd0,0xb7},
    {0x03,0x04},
    {0x04,0x60},
    {0x05,0x04},
    {0x06,0x4c},
    {0x07,0x00},
    {0x08,0x11},
    {0x09,0x00},
    {0x0a,0x02},
    {0x0b,0x00},
    {0x0c,0x02},
    {0x0d,0x04},
    
    {0x0e,0x40},
    {0x12,0xe2},
    {0x13,0x16},
    {0x19,0x0a},
    {0x21,0x1c},
    {0x28,0x0a},
    {0x29,0x24},
    {0x2b,0x04},
    {0x32,0xf8},
    {0x37,0x03},
    {0x39,0x15},
    {0x43,0x07},
    {0x44,0x40},
    {0x46,0x0b},
    {0x4b,0x20},
    {0x4e,0x08},
    {0x55,0x20},
    {0x66,0x05},
    {0x67,0x05},
    {0x77,0x01},
    {0x78,0x00},
    {0x7c,0x93},
    {0x8c,0x12},
    {0x8d,0x92},
    {0x90,0x00},
    {0x9d,0x10},
    {0xce,0x7c},
    {0xd2,0x41},
    {0xd3,0xdc},
    {0xe6,0x50},
    /*gain*/
    {0xb6,0xc0},
    {0xb0,0x70},
    {0xb1,0x01},
    {0xb2,0x00},
    {0xb3,0x00},
    {0xb4,0x00},
    {0xb8,0x01},
    {0xb9,0x00},
    /*blk*/
    {0x26,0x30},
    {0xfe,0x01},
    {0x40,0x23},
    {0x55,0x07},
    {0x60,0x40},
    {0xfe,0x04},
    {0x14,0x78},
    {0x15,0x78},
    {0x16,0x78},
    {0x17,0x78},
    /*window*/
    {0xfe,0x01},
    {0x92,0x01}, // output win start y
    {0x94,0x04}, // output win start x
    {0x95,0x04}, // output win height 1080
    {0x96,0x38},
    {0x97,0x07}, // outout win width  1920
    {0x98,0x80},
    /*DSP2*/
    {0xfe,0x01},
    {0x01,0x05},
    {0x02,0x89},
    {0x04,0x00},//DD_en
    {0x07,0xa6},
    {0x08,0xa9},
    {0x09,0xa8},
    {0x0a,0xa7},
    {0x0b,0xff},
    {0x0c,0xff},
    {0x0f,0x00},
    {0x50,0x1c},
    {0x89,0x03},
    {0xfe,0x04},
    {0x28,0x86},
    {0x29,0x86},
    {0x2a,0x86},
    {0x2b,0x68},
    {0x2c,0x68},
    {0x2d,0x68},
    {0x2e,0x68},
    {0x2f,0x68},
    {0x30,0x4f},
    {0x31,0x68},
    {0x32,0x67},
    {0x33,0x66},
    {0x34,0x66},
    {0x35,0x66},
    {0x36,0x66},
    {0x37,0x66},
    {0x38,0x62},
    {0x39,0x62},
    {0x3a,0x62},
    {0x3b,0x62},
    {0x3c,0x62},
    {0x3d,0x62},
    {0x3e,0x62},
    {0x3f,0x62},
    /****DVP & MIPI****/
    {0xfe,0x01},
    //{0x9a,0x06},    /* VSYNC low pulse */
    {0x9a,0x02},      /* VSYNC high pulse */
    {0xfe,0x00},
    {0x7b,0x2a},
    {0x23,0x2d},
    {0xfe,0x03},
    {0x01,0x20}, // DPHY_analog_mode1
    {0x02,0x56}, // DPHY_analog_mode2
    {0x03,0xb2}, // DPHY_analog_mode3
    {0x12,0x80}, // LWC_set[7:0]
    {0x13,0x07}, // LWC_set[15:8]
    
    {0xfe,0x00},
    {0x3e,0x40},

    /* end of reg list */
    {REGLIST_END, 0x00},
};
static const sensor_reg_16_8_t init_reglist_MIPI_2lane_720p_30fps[] = {
    //window_size=1280*720 mipi@2lane
    //mclk=24mhz,mipi_clk=594Mbps
    //pixel_line_total=2200,line_frame_total=1125
    //row_time=29.629us,frame_rate=30fps
    /****system****/
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x80},
    {0xfe,0x00},
    {0xf2,0x00},
    {0xf3,0x00},
    {0xf4,0x36},
    {0xf5,0xc0},
    {0xf6,0x44},
    {0xf7,0x01},
    {0xf8,0x63},
    {0xf9,0x40},
    {0xfc,0x8e},
    /****CISCTL & ANALOG****/
    {0xfe,0x00},
    {0x87,0x18},
    {0xee,0x30},
    {0xd0,0xb7},
    {0x03,0x04},
    {0x04,0x60},
    {0x05,0x04},
    {0x06,0x4c},
    {0x07,0x00},
    {0x08,0x11},
    {0x09,0x00},
    {0x0a,0x02},
    {0x0b,0x00},
    {0x0c,0x02},
    {0x0d,0x04},
    {0x0e,0x40},
    {0x12,0xe2},
    {0x13,0x16},
    {0x19,0x0a},
    {0x21,0x1c},
    {0x28,0x0a},
    {0x29,0x24},
    {0x2b,0x04},
    {0x32,0xf8},
    {0x37,0x03},
    {0x39,0x15},
    {0x43,0x07},
    {0x44,0x40},
    {0x46,0x0b},
    {0x4b,0x20},
    {0x4e,0x08},
    {0x55,0x20},
    {0x66,0x05},
    {0x67,0x05},
    {0x77,0x01},
    {0x78,0x00},
    {0x7c,0x93},
    {0x8c,0x12},
    {0x8d,0x92},
    {0x90,0x01},
    {0x9d,0x10},
    {0xce,0x7c},
    {0xd2,0x41},
    {0xd3,0xdc},
    {0xe6,0x50},
    /*gain*/  
    {0xb6,0xc0},
    {0xb0,0x70},
    {0xb1,0x01},
    {0xb2,0x00},
    {0xb3,0x00},
    {0xb4,0x00},
    {0xb8,0x01},
    {0xb9,0x00},
    /*blk*/   
    {0x26,0x30},
    {0xfe,0x01},
    {0x40,0x23},
    {0x55,0x07},
    {0x60,0x40},
    {0xfe,0x04},
    {0x14,0x78},
    {0x15,0x78},
    {0x16,0x78},
    {0x17,0x78},
    /*window*/
    {0xfe,0x01},
    {0x92,0xb4},
    {0x93,0x01},
    {0x94,0x40},
    {0x95,0x02},
    {0x96,0xd0},
    {0x97,0x05},
    {0x98,0x00},
    /*DSP2*/   
    {0xfe,0x01},
    {0x01,0x05},
    {0x02,0x89},
    {0x04,0x00},
    {0x07,0xa6},
    {0x08,0xa9},
    {0x09,0xa8},
    {0x0a,0xa7},
    {0x0b,0xff},
    {0x0c,0xff},
    {0x0f,0x00},
    {0x50,0x1c},
    {0x89,0x03},
    {0xfe,0x04},
    {0x28,0x86},
    {0x29,0x86},
    {0x2a,0x86},
    {0x2b,0x68},
    {0x2c,0x68},
    {0x2d,0x68},
    {0x2e,0x68},
    {0x2f,0x68},
    {0x30,0x4f},
    {0x31,0x68},
    {0x32,0x67},
    {0x33,0x66},
    {0x34,0x66},
    {0x35,0x66},
    {0x36,0x66},
    {0x37,0x66},
    {0x38,0x62},
    {0x39,0x62},
    {0x3a,0x62},
    {0x3b,0x62},
    {0x3c,0x62},
    {0x3d,0x62},
    {0x3e,0x62},
    {0x3f,0x62},
    /****DVP & MIPI****/
    {0xfe,0x01},
    {0x9a,0x06},
    {0xfe,0x00},
    {0x7b,0x2a},
    {0x23,0x2d},
    {0xfe,0x03},
    {0x01,0x27},
    {0x02,0x56},
    {0x03,0x8e},
    {0x12,0x80},
    {0x13,0x07},
    {0x15,0x12},
    {0xfe,0x00},
    {0x3e,0x91},
    /* end of reg list */
    {REGLIST_END, 0x00},
};        
static const sensor_reg_16_8_t init_reglist_MIPI_2lane_720p_60fps[] = {
	//window_size=1280*720 mipi@2lane
	//mclk=24mhz,mipi_datarate=528Mbps
	//pixel_line_total=1896,line_frame_total=765
	//row_time=21.54us,frame_rate=60fps
	/****system****/
	{0xfe,0x80},
	{0xfe,0x80},
	{0xfe,0x80},
	{0xfe,0x00},
	{0xf2,0x00}, 
	{0xf3,0x00}, 
	{0xf4,0x36}, 
	{0xf5,0xc0}, 
	{0xf6,0x24}, 
	{0xf7,0x01}, 
	{0xf8,0x2c}, 
	{0xf9,0x12}, 
	{0xfc,0x8e},
	/****CISCTL & ANALOG****/
	{0xfe,0x00},
	{0x87,0x18},
	{0xee,0x30},
	{0xd0,0xb7},
	{0x03,0x04},
	{0x04,0x00},
	{0x05,0x03},
	{0x06,0xb4},
	{0x07,0x00},
	{0x08,0x19},
	{0x09,0x00}, 
	{0x0a,0xaa},
	{0x0b,0x01},
	{0x0c,0x34},
	{0x0d,0x02},
	{0x0e,0xd8},
	{0x0f,0x05},
	{0x10,0x28},
	{0x12,0xe2},
	{0x13,0x16},
	{0x19,0x0a},
	{0x21,0x1c},
	{0x28,0x0a},
	{0x29,0x24},
	{0x2b,0x04},
	{0x32,0xf8},
	{0x37,0x03},
	{0x39,0x15},
	{0x43,0x07},
	{0x44,0x40},
	{0x46,0x0b},
	{0x4b,0x20},
	{0x4e,0x08},
	{0x55,0x20},
	{0x66,0x05},
	{0x67,0x05},
	{0x77,0x01},
	{0x78,0x00},
	{0x7c,0x93},
	{0x8c,0x12},
	{0x8d,0x92},
	{0x90,0x01},
	{0x9d,0x10},
	{0xce,0x7c},
	{0xd2,0x41},
	{0xd3,0xdc},
	{0xda,0x05},
	{0xdb,0xa8},
	{0xe6,0x50},
	/*gain*/ 
	{0xb6,0xc0},
	{0xb0,0x70},
	{0xb1,0x01},
	{0xb2,0x00},
	{0xb3,0x00},
	{0xb4,0x00},
	{0xb8,0x01},
	{0xb9,0x00},
	/*blk*/  
	{0x26,0x30},
	{0xfe,0x01},
	{0x40,0x23},
	{0x55,0x07},
	{0x60,0x40},
	{0xfe,0x04},
	{0x14,0x78},
	{0x15,0x78},
	{0x16,0x78},
	{0x17,0x78},
	/*window*/
	{0xfe,0x01},
	{0x92,0x00},
	{0x94,0x03},
	{0x95,0x02},
	{0x96,0xd0},
	{0x97,0x05},
	{0x98,0x00},
	/*DSP2*/  
	{0xfe,0x01},
	{0x01,0x05},
	{0x02,0x89},
	{0x04,0x01},
	{0x07,0xa6},
	{0x08,0xa9},
	{0x09,0xa8},
	{0x0a,0xa7},
	{0x0b,0xff},
	{0x0c,0xff},
	{0x0f,0x00},
	{0x50,0x1c},
	{0x89,0x03},
	{0xfe,0x04},
	{0x28,0x86},
	{0x29,0x86},
	{0x2a,0x86},
	{0x2b,0x68},
	{0x2c,0x68},
	{0x2d,0x68},
	{0x2e,0x68},
	{0x2f,0x68},
	{0x30,0x4f},
	{0x31,0x68},
	{0x32,0x67},
	{0x33,0x66},
	{0x34,0x66},
	{0x35,0x66},
	{0x36,0x66},
	{0x37,0x66},
	{0x38,0x62},
	{0x39,0x62},
	{0x3a,0x62},
	{0x3b,0x62},
	{0x3c,0x62},
	{0x3d,0x62},
	{0x3e,0x62},
	{0x3f,0x62},
	/****DVP & MIPI****/
	{0xfe,0x01},
	{0x9a,0x06},
	{0xfe,0x00},
	{0x7b,0x2a},
	{0x23,0x2d},
	{0xfe,0x03},
	{0x01,0x27},
	{0x02,0x56},
	{0x03,0x8e},
	{0x12,0x80},
	{0x13,0x07},
	{0x15,0x12},
	{0xfe,0x00},
	{0x3e,0x91},
    /* end of reg list */
    {REGLIST_END, 0x00},
};        


static int enable(sensor_t *sensor)
{
    uint8_t data;

    if (DSP2_INPUT_MIPI_1LANE == DSP2_INPUT_MODE) {
        data = 0x90;
    }
    else if (DSP2_INPUT_MIPI_2LANE == DSP2_INPUT_MODE) {
        data = 0x91;
    }
    else {
        data = 0x40;
    }

    SCCB_Write(sensor->slv_addr, 0xfe,  0x01);
    SCCB_Write(sensor->slv_addr, 0x8c,  0x10);
    SCCB_Write(sensor->slv_addr, 0xfe,  0x00);
    SCCB_Write(sensor->slv_addr, 0x3e,  data);

    return 0;
}

static int disable(sensor_t *sensor)
{
    SCCB_Write(sensor->slv_addr, 0xfe, 0x11);
    SCCB_Write(sensor->slv_addr, 0x8c, 0x90);
    SCCB_Write(sensor->slv_addr, 0xfe, 0x10);
    SCCB_Write(sensor->slv_addr, 0x3e, 0x00);

    return 0;
}
typedef struct _GAIN_TABLE {
    uint8_t Analog_PGA_gain_high;  //0xb4
    uint8_t Analog_PGA_gain_low;   //0xb3
    uint8_t Col_gain_high;         //0xb8
    uint8_t Col_gain_low;          //0xb9
    uint64_t totol_gain;
} GAIN_TABLE;


static const GAIN_TABLE gain_table[] = {
    //0xb4, 0xb3,0xb8, 0xb9, gainX1000
    {0x00,0x00,0x01,0x00,     1000},
	{0x00,0x10,0x01,0x0c,     1188},
	{0x00,0x20,0x01,0x1b,     1406},
	{0x00,0x30,0x01,0x2c,     1688},
	{0x00,0x40,0x01,0x3f,     1984},
	{0x00,0x50,0x02,0x16,     2313},
	{0x00,0x60,0x02,0x35,     2813},
	{0x00,0x70,0x03,0x16,     3375},
	{0x00,0x80,0x04,0x02,     3984},
	{0x00,0x90,0x04,0x31,     4688},
	{0x00,0xa0,0x05,0x32,     5641},
	{0x00,0xb0,0x06,0x35,     6594},
	{0x00,0xc0,0x08,0x04,     7875},
	{0x00,0x5a,0x09,0x19,     9266},
	{0x00,0x83,0x0b,0x0f,    11281},
	{0x00,0x93,0x0d,0x12,    13281},
	{0x00,0x84,0x10,0x00,    15750},
	{0x00,0x94,0x12,0x3a,    18469},
	{0x01,0x2c,0x1a,0x02,    22000},
	{0x01,0x3c,0x1b,0x20,    26391},
	{0x00,0x8c,0x20,0x0f,    31578},
	{0x00,0x9c,0x26,0x07,    37359},
	{0x02,0x64,0x36,0x21,    44531},
	{0x02,0x74,0x37,0x3a,    52641},
	{0x00,0xc6,0x3d,0x02,    62266},
	{0x00,0xdc,0x3f,0x3f,    75078},
	{0x02,0x85,0x3f,0x3f,    90125},
	{0x02,0x95,0x3f,0x3f,   106344},
	{0x00,0xce,0x3f,0x3f,   120672}
};

#define NUM_OF_GAIN (sizeof(gain_table) / sizeof(GAIN_TABLE))

static int SetSensorGain(sensor_t *sensor, uint64_t gain)
{
    uint8_t i = 0, idx = 0;
    uint32_t tol_dig_gain = 0;
    uint8_t Analog_PGA_gain_high,Analog_PGA_gain_low,Col_gain_high,Col_gain_low;
    
    if (gain < GAIN_BASE) {
        gain = GAIN_BASE;
    } else if (gain > (DB_TO_GAIN(MAX_GAIN) * GAIN_BASE)) {
        gain = DB_TO_GAIN(MAX_GAIN) * GAIN_BASE;
    }
    // search most suitable gain into gain table
    for (i = 0; i < NUM_OF_GAIN; i++) {  
        if (gain_table[i].totol_gain > gain){
            idx = i;
            break;
        }
    }
    if (idx == 0){
        tol_dig_gain            = gain * 64 / gain_table[0].totol_gain;
        Analog_PGA_gain_high    = gain_table[0].Analog_PGA_gain_high;
        Analog_PGA_gain_low     = gain_table[0].Analog_PGA_gain_low;
        Col_gain_high           = gain_table[0].Col_gain_high;
        Col_gain_low            = gain_table[0].Col_gain_low;
    }else{
        tol_dig_gain            = gain * 64/ gain_table[idx-1].totol_gain;
        Analog_PGA_gain_high    = gain_table[idx-1].Analog_PGA_gain_high;
        Analog_PGA_gain_low     = gain_table[idx-1].Analog_PGA_gain_low;
        Col_gain_high           = gain_table[idx-1].Col_gain_high;
        Col_gain_low            = gain_table[idx-1].Col_gain_low;
    }

    BL_LOGD("\t\t idx = %d,Analog_PGA_gain_high 0x%02x, Analog_PGA_gain_low 0x%02x, Col_gain_high 0x%02x  Col_gain_low 0x%02x tol_dig_gain 0x%02x\r\n", idx,Analog_PGA_gain_high, Analog_PGA_gain_low, Col_gain_high,Col_gain_low,tol_dig_gain);
    SCCB_Write(sensor->slv_addr, REG_PAGE_SELECT, 0x00);
    SCCB_Write(sensor->slv_addr, REG_ANALOG_PGA_GAIN_HIGH, Analog_PGA_gain_high);
    SCCB_Write(sensor->slv_addr, REG_ANALOG_PGA_GAIN_LOW,  Analog_PGA_gain_low);
    SCCB_Write(sensor->slv_addr, REG_COL_GAIN_HIGH,        Col_gain_high);
    SCCB_Write(sensor->slv_addr, REG_COL_GAIN_LOW,         Col_gain_low);
    SCCB_Write(sensor->slv_addr, REG_AUTO_PREGAIN_SYNC,   (tol_dig_gain>>6));
    SCCB_Write(sensor->slv_addr, REG_AUTO_PREGAIN,        ((tol_dig_gain&0x3f)<<2));
    return 0;
}

static int SetSensorIntt(sensor_t *sensor, uint32_t intt)
{
    SCCB_Write(sensor->slv_addr, REG_PAGE_SELECT, 0x00);
    SCCB_Write(sensor->slv_addr, REG_SHUTTER_TIME_H, (intt>>8));
    SCCB_Write(sensor->slv_addr, REG_SHUTTER_TIME_L, (intt&0xff));

    return 0;
}

static int SetFlipMirrow(sensor_t *sensor, uint8_t type)
{
    SCCB_Write(sensor->slv_addr, REG_PAGE_SELECT, 0x00);
    if (type == FLIP_MIRROR_TYPE_NORMAL) SCCB_Write(sensor->slv_addr, REG_FLIP_MIRROR, 0x00);
    else if (type == FLIP_MIRROR_TYPE_MIRROR) SCCB_Write(sensor->slv_addr, REG_FLIP_MIRROR, 0x01);
    else if (type == FLIP_MIRROR_TYPE_FLIP) SCCB_Write(sensor->slv_addr, REG_FLIP_MIRROR, 0x2);
    else if (type == FLIP_MIRROR_TYPE_FLIP_MIRROR) SCCB_Write(sensor->slv_addr, REG_FLIP_MIRROR, 0x03);
    return 0;
}

static int SetFPS(sensor_t *sensor, uint32_t fps)
{
    uint8_t data_H, data_L;
    int total_height = 0;

    if (fps > fps_tbl.fps) return -1;
    if (fps < 1) return -1;

    if (fps == fps_tbl.fps) {
        total_height = fps_tbl.VTS;
    } else {
        total_height = fps_tbl.VTS * fps_tbl.fps / fps;
    }

    data_L = total_height & 0xff;
    data_H = total_height >> 8;

    SCCB_Write(sensor->slv_addr, REG_PAGE_SELECT, 0x00);
    SCCB_Write(sensor->slv_addr, REG_TOTAL_HEIGHT_H, data_H);
    SCCB_Write(sensor->slv_addr, REG_TOTAL_HEIGHT_L, data_L);
    return 0;
}

/******************************************************/
static int set_exposure(sensor_t *sensor, BL_EXPO_TIME expo_time)
{
    uint64_t tmp = expo_time * (uint64_t)sensor->pix_clk;
    int num_line = NS_TO_SEC(tmp / sensor->total_win.width);
    SetSensorIntt(sensor, num_line);
    return 0;
}

static int set_gain(sensor_t *sensor, BL_GAIN_DB gain)
{
    uint64_t gain2 = pow(2, (GAIN_DB_INT_TO_FLOAT(gain)/6)) * GAIN_BASE;
    BL_LOGD("\t\t----------------gain = %d gain2 = %lu \r\n", gain, gain2);
    SetSensorGain(sensor, gain2);
    return 0;
}

static int set_flipmirror(sensor_t *sensor, FLIP_MIRROR_TYPE_E type)
{
    uint8_t type_e = type;
    SetFlipMirrow(sensor, type_e);
    return 0;
}

static int set_fps(sensor_t *sensor, uint32_t fps)
{
    int ret = 0;
    ret = SetFPS(sensor, fps);
    sensor->max_expo_time = INT_TO_EXPO_TIME(fps);
    return ret;
}

static void inti_fps_tbl(sensor_t *sensor)
{
    uint8_t data_H, data_L;

    SCCB_Write(sensor->slv_addr, REG_PAGE_SELECT, 0x00);
    SCCB_Read(sensor->slv_addr, REG_TOTAL_HEIGHT_H, &data_H);
    SCCB_Read(sensor->slv_addr, REG_TOTAL_HEIGHT_L, &data_L);

    fps_tbl.VTS = data_H;
    fps_tbl.VTS = (fps_tbl.VTS << 8) + (data_L & 0xff);
    fps_tbl.fps = sensor->fps;
    //BL_LOGD("===== total height: %d, fps: %d, data: H:0x%x, L:0x%x\r\n",
    //    fps_tbl.total_height, fps_tbl.fps, data_H, data_L);
}
static int setFmt(sensor_t *sensor)
{
    int i;
    FORMAT_INDEX format_index;
    const sensor_reg_16_8_t *init_reglist;

    switch (sensor->video_mode) {
    case VIDEO_MODE_1080P_15:
        if (DSP2_INPUT_MIPI_2LANE == DSP2_INPUT_MODE) {
            format_index = FORMAT_INDEX_MIPI_2_LANE_1080P_15;
            init_reglist = init_reglist_MIPI_2lane_1080p_15fps;
        } else {
            return -1;
        }
        sensor->max_expo_time = EXPO_TIME_1_15_SEC;       /* 1/15 sec */
        sensor->out_win.width  = 1920;
        sensor->out_win.height = 1080;
        break;
    case VIDEO_MODE_1080P_25:
        if (DSP2_INPUT_MIPI_2LANE == DSP2_INPUT_MODE) {
            format_index = FORMAT_INDEX_MIPI_2_LANE_1080P_25;
            init_reglist = init_reglist_MIPI_2lane_1080p_25fps;
        } else if (DSP2_INPUT_DVP == DSP2_INPUT_MODE) {
            format_index = FORMAT_INDEX_DVP_1080P_25;
            init_reglist = init_reglist_25fps;
        } else {
            return -1;
        }
        sensor->max_expo_time = EXPO_TIME_1_25_SEC;       /* 1/25 sec */
        sensor->out_win.width  = 1920;
        sensor->out_win.height = 1080;
        break;
    case VIDEO_MODE_720P_59_94:
            if (DSP2_INPUT_DVP == DSP2_INPUT_MODE) {
                format_index = FORMAT_INDEX_DVP_720P_60;
                init_reglist = init_reglist_720p_60fps;
            }else if (DSP2_INPUT_MIPI_2LANE == DSP2_INPUT_MODE) {
                format_index = FORMAT_INDEX_MIPI_2_LANE_720P_60;
                init_reglist = init_reglist_MIPI_2lane_720p_60fps;
                printf("init_reglist_MIPI_2lane_720p_60fps\n");
            }else {
                return -1;
            }
            sensor->max_expo_time = EXPO_TIME_1_60_SEC;
            sensor->out_win.width  = 1280;
            sensor->out_win.height = 720;
            break;
    case VIDEO_MODE_720P_30:
            if (DSP2_INPUT_DVP == DSP2_INPUT_MODE) {
                format_index = FORMAT_INDEX_DVP_720P_30;
                init_reglist = init_reglist_720p_30fps;
                printf("init_reglist_720p_30fps\n");
            } else if (DSP2_INPUT_MIPI_2LANE == DSP2_INPUT_MODE) {
                format_index = FORMAT_INDEX_MIPI_2_LANE_720P_30;
                init_reglist = init_reglist_MIPI_2lane_720p_30fps;
                printf("init_reglist_MIPI_2lane_720p_30fps\n");
            }  else if (DSP2_INPUT_MIPI_1LANE == DSP2_INPUT_MODE) {
                format_index = FORMAT_INDEX_MIPI_1_LANE_720P_30;
                init_reglist = init_reglist_MIPI_1lane_720p_30fps;
                printf("init_reglist_MIPI_1lane_720p_30fps\n");
            } 
            else {
                return -1;
            }
            
            sensor->max_expo_time = EXPO_TIME_1_30_SEC;
            sensor->out_win.width  = 1280;
            sensor->out_win.height = 720;
            break;
    case VIDEO_MODE_1080P_30:
            if (DSP2_INPUT_MIPI_1LANE == DSP2_INPUT_MODE) {
                format_index = FORMAT_INDEX_MIPI_1_LANE_1080P_30;
                init_reglist = init_reglist_MIPI_1lane_1080p_30fps;
            } else if (DSP2_INPUT_MIPI_2LANE == DSP2_INPUT_MODE) {
                format_index = FORMAT_INDEX_MIPI_2_LANE_1080P_30;
                init_reglist = init_reglist_MIPI_2lane_1080p_30fps;
            } else if (DSP2_INPUT_DVP == DSP2_INPUT_MODE) {
                format_index = FORMAT_INDEX_DVP_1080P_30;
                init_reglist = init_reglist_30fps;
            } else {
                return -1;
            }
            sensor->max_expo_time = EXPO_TIME_1_30_SEC;
            sensor->out_win.width  = 1920;
            sensor->out_win.height = 1080;
            break;

    default:
        BL_LOGE("set_format error: invalid video mode!\r\n");
        return -1;
    }

    sensor->pix_clk             = format_info[format_index].pix_clk;
    sensor->fps                 = format_info[format_index].fps;
    sensor->total_win.width     = format_info[format_index].total_width;
    sensor->total_win.height    = format_info[format_index].total_height;
    sensor->bayer_pattern       = format_info[format_index].bayer_pattern;


    for (i = 0; init_reglist[i].addr != REGLIST_END; i++) {
        SCCB_Write(sensor->slv_addr, init_reglist[i].addr, (uint8_t)init_reglist[i].data);
    }
    inti_fps_tbl(sensor);
    SetFlipMirrow(sensor, FLIP_MIRROR_TYPE_FLIP_MIRROR);

    //SCCB_Write_Reg16(sensor->slv_addr, REG_TOTAL_WIDTH_H, (uint8_t)(sensor->total_win.width >> 8));
    //SCCB_Write_Reg16(sensor->slv_addr, REG_TOTAL_WIDTH_L, (uint8_t)sensor->total_win.width);
    //SCCB_Write_Reg16(sensor->slv_addr, REG_TOTAL_HEIGHT_H, (uint8_t)(sensor->total_win.height >> 8));
    //SCCB_Write_Reg16(sensor->slv_addr, REG_TOTAL_HEIGHT_L, (uint8_t)sensor->total_win.height);

    // uint8_t data;
    // SCCB_Write(sensor->slv_addr, 0xfe, 0x10);
    // SCCB_Read(sensor->slv_addr, 0x3e, &data);
    // printf("[0x3e] = 0x%x\r\n", data);

    return 0;
}

static int get_property(sensor_t *sensor, sensor_property_t *property)
{
    CHECK_PARAM(sensor != NULL);

    property->bayer_pattern = sensor->bayer_pattern;//BAYER_PATTERN_BG;

    return 0;
}

static int probe(void)
{
    return sensor_probe_8bit(SLAVE_ADDR, REG_SENSOR_ID_H, REG_SENSOR_ID_L, SENSOR_ID_H, SENSOR_ID_L);
}

static int init(sensor_t *sensor)
{
    int mode_num = sizeof(gc2053_mode)/sizeof(gc2053_mode[0]);
    if (!is_sensor_dsp2_input_match(gc2053_mode, mode_num)) {
        return -1;
    }

    /* Initialize sensor structure */
    SENSOR_INIT_COMMON(GC2053);

    //set_format(sensor, VIDEO_MODE_1080P_25);

#if 0   // enable test pattern
    SCCB_Write_Reg16(sensor->slv_addr, 0x4501, 0xc8);     /* test pattern enable */
    SCCB_Write_Reg16(sensor->slv_addr, 0x3902, 0x05);     /* manual BLC  */
#endif

    return 0;
}

const BL_SENSOR_DESC_T sensor_desc_gc2053 ATTR_SENSOR_DEVICE_TABLE =
{
    "GC2053",
    SLAVE_ADDR,
    probe,
    init,
    setFmt,
};

